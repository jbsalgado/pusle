<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - API Cliente</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold mb-6">üîç Diagn√≥stico da API de Cliente</h1>
            
            <!-- Configura√ß√µes -->
            <div class="mb-6 p-4 bg-blue-50 rounded">
                <h2 class="text-xl font-semibold mb-3">‚öôÔ∏è Configura√ß√µes</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">URL Base da API:</label>
                        <input type="text" id="urlBase" 
                               value="/pulse/basic/web/index.php/api" 
                               class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">ID do Cliente para Teste:</label>
                        <input type="text" id="clienteId" 
                               value="b3ef303e-5db3-4648-9f31-cfab0c4cc477" 
                               class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">ID da Loja (usuario_id):</label>
                        <input type="text" id="usuarioId" 
                               value="a99a38a9-e368-4a47-a4bd-02ba3bacaa76" 
                               class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">CPF para Teste:</label>
                        <input type="text" id="cpfTeste" 
                               value="12345678900" 
                               placeholder="Apenas n√∫meros"
                               class="w-full px-3 py-2 border rounded">
                    </div>
                </div>
            </div>
            
            <!-- Bot√µes de Teste -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-3">üß™ Testes Dispon√≠veis</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    <button onclick="testarBuscarCliente()" 
                            class="bg-blue-500 text-white px-4 py-3 rounded hover:bg-blue-600 transition">
                        üìã Buscar Cliente por ID
                    </button>
                    <button onclick="testarBuscarCPF()" 
                            class="bg-green-500 text-white px-4 py-3 rounded hover:bg-green-600 transition">
                        üîç Buscar por CPF
                    </button>
                    <button onclick="testarListarClientes()" 
                            class="bg-purple-500 text-white px-4 py-3 rounded hover:bg-purple-600 transition">
                        üìú Listar Clientes
                    </button>
                    <button onclick="testarConexao()" 
                            class="bg-yellow-500 text-white px-4 py-3 rounded hover:bg-yellow-600 transition">
                        üåê Testar Conex√£o
                    </button>
                    <button onclick="executarTodosTestes()" 
                            class="bg-red-500 text-white px-4 py-3 rounded hover:bg-red-600 transition">
                        ‚ö° Executar Todos
                    </button>
                    <button onclick="limparResultados()" 
                            class="bg-gray-500 text-white px-4 py-3 rounded hover:bg-gray-600 transition">
                        üßπ Limpar Resultados
                    </button>
                </div>
            </div>
            
            <!-- Console de Debug -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-3">üìä Console de Debug</h2>
                <div id="console" class="bg-black text-green-400 font-mono text-sm p-4 rounded h-96 overflow-y-auto">
                    <div class="text-yellow-300">Sistema de diagn√≥stico iniciado...</div>
                </div>
            </div>
            
            <!-- Resultado dos Testes -->
            <div id="resultados" class="space-y-4"></div>
        </div>
    </div>

    <script>
        // Configura√ß√µes globais
        let testeAtual = 1;
        
        // Fun√ß√£o para adicionar log ao console
        function log(mensagem, tipo = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const cores = {
                'info': 'text-white',
                'success': 'text-green-400',
                'error': 'text-red-400',
                'warning': 'text-yellow-400',
                'debug': 'text-gray-400'
            };
            
            const linha = document.createElement('div');
            linha.className = cores[tipo] || 'text-white';
            linha.innerHTML = `[${timestamp}] ${mensagem}`;
            console.appendChild(linha);
            console.scrollTop = console.scrollHeight;
        }
        
        // Fun√ß√£o para adicionar resultado visual
        function adicionarResultado(titulo, dados, sucesso = true) {
            const resultados = document.getElementById('resultados');
            const card = document.createElement('div');
            card.className = `p-4 rounded ${sucesso ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300'} border`;
            
            card.innerHTML = `
                <div class="flex items-center mb-2">
                    <span class="text-2xl mr-2">${sucesso ? '‚úÖ' : '‚ùå'}</span>
                    <h3 class="font-semibold">${titulo}</h3>
                </div>
                <pre class="bg-white p-3 rounded text-xs overflow-x-auto">${JSON.stringify(dados, null, 2)}</pre>
            `;
            
            resultados.insertBefore(card, resultados.firstChild);
        }
        
        // Fun√ß√£o para fazer requisi√ß√µes
        async function fazerRequisicao(url, options = {}) {
            log(`üì° Fazendo requisi√ß√£o para: ${url}`, 'debug');
            
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                log(`üìä Status da resposta: ${response.status} ${response.statusText}`, 
                    response.ok ? 'success' : 'warning');
                
                const text = await response.text();
                log(`üìÑ Tamanho da resposta: ${text.length} bytes`, 'debug');
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    log(`‚ö†Ô∏è Resposta n√£o √© JSON v√°lido: ${text.substring(0, 200)}...`, 'warning');
                    data = { rawResponse: text };
                }
                
                return {
                    ok: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    data: data
                };
                
            } catch (error) {
                log(`‚ùå Erro na requisi√ß√£o: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // Teste: Buscar Cliente por ID
        async function testarBuscarCliente() {
            const urlBase = document.getElementById('urlBase').value;
            const clienteId = document.getElementById('clienteId').value;
            const url = `${urlBase}/cliente/${clienteId}`;
            
            log(`\nüîç TESTE ${testeAtual++}: Buscar Cliente por ID`, 'info');
            log(`Cliente ID: ${clienteId}`, 'debug');
            
            try {
                const result = await fazerRequisicao(url);
                
                if (result.ok) {
                    log(`‚úÖ Cliente encontrado: ${result.data.nome_completo || result.data.nome}`, 'success');
                    adicionarResultado('Buscar Cliente por ID', result.data, true);
                } else {
                    log(`‚ùå Erro ao buscar cliente: ${JSON.stringify(result.data)}`, 'error');
                    adicionarResultado('Buscar Cliente por ID - ERRO', result.data, false);
                }
            } catch (error) {
                log(`üí• Exce√ß√£o capturada: ${error.message}`, 'error');
                adicionarResultado('Buscar Cliente por ID - EXCE√á√ÉO', {error: error.message}, false);
            }
        }
        
        // Teste: Buscar por CPF
        async function testarBuscarCPF() {
            const urlBase = document.getElementById('urlBase').value;
            const cpf = document.getElementById('cpfTeste').value;
            const usuarioId = document.getElementById('usuarioId').value;
            const url = `${urlBase}/cliente/buscar-cpf?cpf=${cpf}&usuario_id=${usuarioId}`;
            
            log(`\nüîç TESTE ${testeAtual++}: Buscar Cliente por CPF`, 'info');
            log(`CPF: ${cpf}, Usuario ID: ${usuarioId}`, 'debug');
            
            try {
                const result = await fazerRequisicao(url);
                
                if (result.ok) {
                    if (result.data.existe) {
                        log(`‚úÖ Cliente encontrado: ${result.data.cliente.nome_completo}`, 'success');
                    } else {
                        log(`‚ÑπÔ∏è Cliente n√£o existe com este CPF`, 'warning');
                    }
                    adicionarResultado('Buscar por CPF', result.data, true);
                } else {
                    log(`‚ùå Erro ao buscar por CPF: ${JSON.stringify(result.data)}`, 'error');
                    adicionarResultado('Buscar por CPF - ERRO', result.data, false);
                }
            } catch (error) {
                log(`üí• Exce√ß√£o capturada: ${error.message}`, 'error');
                adicionarResultado('Buscar por CPF - EXCE√á√ÉO', {error: error.message}, false);
            }
        }
        
        // Teste: Listar Clientes
        async function testarListarClientes() {
            const urlBase = document.getElementById('urlBase').value;
            const usuarioId = document.getElementById('usuarioId').value;
            const url = `${urlBase}/cliente?termo=teste&usuario_id=${usuarioId}`;
            
            log(`\nüìú TESTE ${testeAtual++}: Listar Clientes`, 'info');
            log(`Termo de busca: "teste", Usuario ID: ${usuarioId}`, 'debug');
            
            try {
                const result = await fazerRequisicao(url);
                
                if (result.ok) {
                    log(`‚úÖ ${result.data.length} clientes encontrados`, 'success');
                    adicionarResultado('Listar Clientes', result.data, true);
                } else {
                    log(`‚ùå Erro ao listar clientes: ${JSON.stringify(result.data)}`, 'error');
                    adicionarResultado('Listar Clientes - ERRO', result.data, false);
                }
            } catch (error) {
                log(`üí• Exce√ß√£o capturada: ${error.message}`, 'error');
                adicionarResultado('Listar Clientes - EXCE√á√ÉO', {error: error.message}, false);
            }
        }
        
        // Teste: Verificar Conex√£o
        async function testarConexao() {
            const urlBase = document.getElementById('urlBase').value;
            
            log(`\nüåê TESTE ${testeAtual++}: Verificar Conex√£o com API`, 'info');
            
            // Teste 1: Verificar se a URL base responde
            try {
                const baseUrl = urlBase.replace('/api', '');
                log(`Testando URL base: ${baseUrl}`, 'debug');
                
                const response = await fetch(baseUrl, { method: 'HEAD' });
                
                if (response.ok || response.status === 404 || response.status === 405) {
                    log(`‚úÖ Servidor respondendo`, 'success');
                } else {
                    log(`‚ö†Ô∏è Servidor retornou status: ${response.status}`, 'warning');
                }
                
                adicionarResultado('Teste de Conex√£o', {
                    servidor: 'respondendo',
                    status: response.status,
                    urlBase: baseUrl
                }, true);
                
            } catch (error) {
                log(`‚ùå Servidor n√£o acess√≠vel: ${error.message}`, 'error');
                adicionarResultado('Teste de Conex√£o - ERRO', {
                    erro: error.message,
                    urlBase: urlBase
                }, false);
            }
            
            // Teste 2: Verificar CORS
            log(`Verificando headers CORS...`, 'debug');
            try {
                const response = await fetch(`${urlBase}/cliente`, {
                    method: 'OPTIONS'
                });
                
                const corsHeaders = {
                    'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
                    'access-control-allow-methods': response.headers.get('access-control-allow-methods'),
                    'access-control-allow-headers': response.headers.get('access-control-allow-headers')
                };
                
                log(`Headers CORS: ${JSON.stringify(corsHeaders)}`, 'debug');
                
                if (corsHeaders['access-control-allow-origin']) {
                    log(`‚úÖ CORS configurado corretamente`, 'success');
                } else {
                    log(`‚ö†Ô∏è CORS pode n√£o estar configurado`, 'warning');
                }
                
            } catch (error) {
                log(`‚ö†Ô∏è N√£o foi poss√≠vel verificar CORS: ${error.message}`, 'warning');
            }
        }
        
        // Executar todos os testes
        async function executarTodosTestes() {
            log(`\n‚ö° EXECUTANDO TODOS OS TESTES...`, 'warning');
            
            await testarConexao();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testarBuscarCliente();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testarBuscarCPF();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testarListarClientes();
            
            log(`\n‚úÖ TODOS OS TESTES CONCLU√çDOS!`, 'success');
        }
        
        // Limpar resultados
        function limparResultados() {
            document.getElementById('resultados').innerHTML = '';
            document.getElementById('console').innerHTML = '<div class="text-yellow-300">Console limpo. Sistema pronto para novos testes...</div>';
            testeAtual = 1;
            log('Sistema de diagn√≥stico reiniciado', 'info');
        }
        
        // Inicializa√ß√£o
        window.addEventListener('DOMContentLoaded', () => {
            log('‚úÖ Sistema de diagn√≥stico carregado e pronto', 'success');
            log('Clique nos bot√µes acima para executar os testes', 'info');
        });
    </script>
</body>
</html>