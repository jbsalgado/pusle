<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para os botões de visualização */
        .btn-view.active {
            background-color: #2563eb; /* bg-blue-600 */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100">

    <header class="bg-white shadow-md sticky top-0 z-10">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="index.html" class="text-blue-600 hover:text-blue-800">
                &larr; Voltar ao Catálogo
            </a>
            <h1 class="text-xl font-bold text-gray-800">Meus Pedidos</h1>
        </nav>
    </header>

    <main class="container mx-auto p-4">

        <div class="flex justify-end gap-2 mb-4">
            <button id="btn-view-list" class="btn-view active p-2 rounded-lg border bg-white" title="Visualização em Lista">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                </svg>
            </button>
            <button id="btn-view-grid" class="btn-view p-2 rounded-lg border bg-white" title="Visualização em Grade">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                </svg>
            </button>
        </div>

        <div id="pedidos-container" class="grid grid-cols-1 gap-4">
            </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('pedidos-container');
            const btnList = document.getElementById('btn-view-list');
            const btnGrid = document.getElementById('btn-view-grid');

            // ID do cliente (simulado, como no app.js)
            const CLIENTE_ID = 'cliente-simulado-uuid'; //
            const API_URL = `/pulse/basic/web/index.php/api/pedido?cliente_id=${CLIENTE_ID}`;

            /**
             * Formata a data para (DD/MM/AAAA HH:mm)
             */
            function formatarData(dataISO) {
                const data = new Date(dataISO);
                const dia = String(data.getDate()).padStart(2, '0');
                const mes = String(data.getMonth() + 1).padStart(2, '0');
                const ano = data.getFullYear();
                const horas = String(data.getHours()).padStart(2, '0');
                const minutos = String(data.getMinutes()).padStart(2, '0');
                return `${dia}/${mes}/${ano} às ${horas}:${minutos}`;
            }
            
             /**
             * Formata o status
             */
            function formatarStatus(status) {
                // Tailwind classes para os status
                const classes = {
                    'PENDENTE': 'bg-yellow-100 text-yellow-800',
                    'PAGO': 'bg-green-100 text-green-800',
                    'CANCELADO': 'bg-red-100 text-red-800',
                };
                return classes[status] || 'bg-gray-100 text-gray-800';
            }

            /**
             * Renderiza um card de pedido
             */
            function renderizarPedido(pedido) {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md overflow-hidden p-4 flex flex-col gap-3';

                const statusClass = formatarStatus(pedido.status_venda_codigo);

                // 1. Cabeçalho do Card
                const header = `
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 border-b pb-3">
                        <div>
                            <p class="text-sm text-gray-500">Pedido Realizado</p>
                            <p class="text-lg font-semibold text-gray-800">${formatarData(pedido.data_venda)}</p>
                        </div>
                        <span class="text-sm font-medium px-3 py-1 rounded-full ${statusClass} self-start sm:self-center">
                            ${pedido.status_venda_codigo}
                        </span>
                    </div>`;

                // 2. Itens do Pedido
                const itensHtml = pedido.itens.map(item => `
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-700">${item.quantidade}x ${item.produto.nome}</span>
                        <span class="text-gray-600">R$ ${parseFloat(item.valor_total_item).toFixed(2)}</span>
                    </div>
                `).join('');

                // 3. Rodapé do Card
                const footer = `
                    <div class="border-t pt-3 mt-auto flex justify-between items-center">
                        <span class="text-base font-medium text-gray-600">Valor Total:</span>
                        <span class="text-xl font-bold text-blue-600">R$ ${parseFloat(pedido.valor_total).toFixed(2)}</span>
                    </div>`;
                
                card.innerHTML = header + '<div class="flex flex-col gap-1">' + itensHtml + '</div>' + footer;
                return card;
            }

            /**
             * Busca e exibe os pedidos
             */
            async function carregarPedidos() {
                try {
                    container.innerHTML = '<p>Carregando pedidos...</p>';
                    const response = await fetch(API_URL);
                    if (!response.ok) throw new Error(`Erro de rede: ${response.statusText}`);
                    
                    const data = await response.json(); // O ActiveDataProvider retorna um objeto
                    
                    if (data.items && data.items.length > 0) {
                        container.innerHTML = '';
                        data.items.forEach(pedido => {
                            const pedidoCard = renderizarPedido(pedido);
                            container.appendChild(pedidoCard);
                        });
                    } else {
                        container.innerHTML = '<p>Nenhum pedido encontrado.</p>';
                    }

                } catch (error) {
                    console.error('Falha ao carregar pedidos:', error);
                    container.innerHTML = '<p class="text-red-500">Erro ao carregar pedidos.</p>';
                }
            }

            // --- Event Listeners para Mudar Visualização ---
            
            btnList.addEventListener('click', () => {
                // Mobile-first já é 1 coluna, então só removemos as classes de grid
                container.classList.remove('md:grid-cols-2', 'lg:grid-cols-3');
                btnList.classList.add('active');
                btnGrid.classList.remove('active');
            });

            btnGrid.addEventListener('click', () => {
                // Adiciona classes responsivas para grid
                container.classList.add('md:grid-cols-2', 'lg:grid-cols-3');
                btnGrid.classList.add('active');
                btnList.classList.remove('active');
            });

            // Carga inicial
            carregarPedidos();
        });
    </script>
</body>
</html>